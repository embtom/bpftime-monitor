###########################################################
# Stage 1: build‑env image
###########################################################
FROM debian:trixie AS build-env

ARG DEBIAN_FRONTEND=noninteractive

ENV PIP_ROOT_USER_ACTION=ignore
ENV PIP_BREAK_SYSTEM_PACKAGES=1
ENV LANG=en_US.UTF-8
ENV LC_ALL=en_US.UTF-8

# Core build‑environment packages
RUN apt-get update \
 && apt-get install --yes --no-install-recommends \
    bpftool \
    build-essential \
    cdbs \
    clang \
    cmake \
    devscripts \
    dumb-init \
    equivs \
    fakeroot \
    g++-aarch64-linux-gnu \
    gcc-aarch64-linux-gnu \
    git \
    libc6-dev-arm64-cross \
    libcxxopts-dev \
    locales \
    ninja-build \
    pkg-config \
    qemu-user-static \
 && sed -i 's/^# *en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/' /etc/locale.gen \
 && locale-gen \
 && rm -rf /var/lib/apt/lists/*

# Multi‑arch libraries (amd64 & arm64)
RUN dpkg --add-architecture arm64 \
 && apt-get update \
 && for arch in amd64 arm64; do \
      apt-get install --yes --no-install-recommends \
        libbpf-dev:${arch} \
        libgtest-dev:${arch} \
        libspdlog-dev:${arch} \
        pkgconf:${arch} ; \
    done \
 && rm -rf /var/lib/apt/lists/*

###########################################################
# Stage 2: dev‑env container
###########################################################
FROM build-env AS dev-env

SHELL ["/bin/bash", "-o", "pipefail", "-c"]

RUN apt-get update \
 && apt-get install --yes --no-install-recommends \
        bash-completion \
        ca-certificates \
        clang-format \
        cmake-format \
        curl \
        default-jdk-headless \
        gdb \
        gdb-multiarch \
        gnupg2 \
        nano \
        openssh-client \
        python3-pip \
        shfmt \
        starship \
        unzip \
        wget \
        zsh && \
    rm -rf /var/lib/apt/lists/*

RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - \
 && apt-get install -y --no-install-recommends nodejs=20.* \
 && rm -rf /var/lib/apt/lists/*

RUN cat <<'EOF' >> /etc/bash.bashrc
if [ -f /usr/share/bash-completion/bash_completion ]; then
  . /usr/share/bash-completion/bash_completion
fi

eval "$(starship init bash)"
EOF

CMD ["/usr/bin/bash"]
